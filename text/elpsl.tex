\chapter{Expected length of the longest chain}

\begin{section}{Influence of bucket's size on time complexity}
We already explained why the size of a bucket is so important for hashing. Assume a model of hashing storing elements in separate buckets of a hash table. A chain is created from the elements stored in a single bucket and is frequently represented by a singly linked list, hence the word chain. To find an element in a bucket (or chain) one needs to iterate it. Thus the time of the find operation is linear with the number of elements that fell in the bucket. An approach, how to estimate the expected length of the longest chain when classic and using universal hashing, is shown.

\begin{definition}[Equality indicator]
Let $x$ and $y$ be two variables from the same set $B$. Then function $\mathbf{I}: B \times B \rightarrow \{0, 1\}$ such that
\[
 \mathbf{I}(y = x) =
  \begin{cases}
   1 & \text{if } x = y \\
   0 & \text{if } x \neq y
  \end{cases}
\]
is called equality indicator.
\end{definition}

\begin{definition}[Probe sequence length, longest probe sequence length]
Let $H$ be universal class of functions hashing universe $U$ onto a table $B$. Let $a \in B$ be a bucket of $B$ and $S \subseteq U$ be the represented set. 

Then length of the chain with the address $a$ when hashing by function $h$ is denoted by the variable $\psl(a, h) = \displaystyle \sum_{x \in S} \Indicator(h(x) = a)$. Variable $\lpsl(h) = \displaystyle \max_{a \in B} (\psl(a, h))$ denotes the length of the longest chain when using function $h$.
\end{definition}

Notation probe sequence comes from coalesced hashing. Chains are represented directly in the hash table and they are fused together even for elements with different hash values. Many authors refer to the process of finding an element in a chain as probing the sequence. The authors denote these random variables by names $\psl$ and $\lpsl$, too. % TODO: citation.

Whenever any expectation over variables $\psl$, $\lpsl$ is taken it is performed over the choice of a function $h \in H$. The bounds on the variable $\lpsl$ that are obtained must be valid for any hashed set $S \subseteq U$ and depend on the size of the hashed set only. If we are able to find a tight upper bound on the length of the longest chain we can guarantee the worst case behaviour of the model. When the limit is broken we can choose any other function from the universal class of functions $H$ and rehash stored elements so that we obtain a table that does not violate the chain limit rule.

When taking the probability into an account we define random variables $\psl$ and $\lpsl$ over the probability space determined by a choice of hash function $h \in H$ where $H$ is a universal class of hash functions used.

\begin{definition}[Random variables of probe sequence length and longest probe sequence length]
Random variable $\psl(a)$ denotes the size of the bucket with the address $a \in B$. Its values are from $\mathbb{N}$ and probability density function is defined as:
\[
\Prob{\psl(a) = k} = \frac{\sum_{h \in H} \Indicator(\psl(a, h) = k)}{|H|}\text{.}
\]

Random variable $\lpsl$ denoting the maximal size of a bucket in a hash table is defined as:
\[
\lpsl = \displaystyle\max_{a \in B}(\psl(a))\text{.}
\]
\end{definition}
\end{section}

\begin{section}{Estimating length of the longest chain in the classic model of hashing}
The standard result of classic hashing is the $O\left(\frac{\log n}{\log \log n}\right)$ bound on the length of the longest chain for the hashing. We can use computations in its proof to show that the same bound holds for universal hashing with strongly $\omega$-universal class of functions. In order to prove this result we need to estimate the probability of collision of $k$ elements. Simplest model of hashing uses an assumption that is not necessarily satisfied; hashed elements are independently and uniformly chosen from the universe $U$. This is enough to solve this problem in the area of classic hashing. 

The above definitions are intended for models of universal hashing. However they are easy to understand with standard hashing, too. 

Notice when using standard model we do not have to mention the additional parameter $h$ of variables $\psl$ and $\lpsl$ because the standard model assumes usage of just one hash function. Probability computed in this model is taken over the choice of the hashed set $S \subset U$. 

Restrictions placed on the hash function say that it distributes the elements of universe uniformly across the hash table. Hence the other parameter, bucket $b \in B$, of variable $\psl$ is no longer necessary, too. For every pair of buckets $a, b \in B$ random variables $\psl(a)$ and $\psl(b)$ then have same probabilities of being equal to a number $k \in \mathbb{N}$: \[\Prob{\psl(a) = k} = \Prob{\psl(b) = k} \text{.}\] In this chapter $m$ denotes the size of the hash table $B$ and $n$ is the size of the hashed set $S$.

The probability estimate for the variable $\lpsl$ is simply obtained from the probability estimate of $\psl$ as:
\begin{displaymath}
\Prob{\lpsl \geq i} \leq m \Prob{\psl(a) \geq i \text{ for any } a \in B}
\end{displaymath}

\begin{displaymath}
\begin{split}
\Expect{\lpsl}
	& = \displaystyle \sum_{i=0}^{\infty} i \Prob{\lpsl = i} \\
	& = \displaystyle \sum_{i = 0}^{\infty} i (\Prob{\lpsl \geq i} - \Prob{\lpsl \geq i + 1}) \\ 
	& = \displaystyle \sum_{i = 0}^{\infty} \Prob{\lpsl \geq i}
\end{split}
\end{displaymath}

And thus we have:
\begin{displaymath}
\Expect{\lpsl} \leq \displaystyle \sum_{i = 0}^{\infty} m \Prob{\psl \geq i}
\end{displaymath}

Because the used hash function divides universe $U$ uniformly among buckets, probability of the event that an element is hashed into a prescribed bucket is $\frac{1}{m}$. The assumption of independent and uniform choice of the hashed element implies that the probability of collision may be estimated as a binomial random variable. 
\begin{displaymath}
\Prob{\psl \geq i} \leq \dbinom{n}{i}\left(\frac{1}{m}\right)^i
\end{displaymath}
Remark that this estimate holds only when the universe is substantially larger than the hashed set. Selection of the first element slightly changes the probability of choice of the second element and so on. This fact may be neglected for large or infinite universes.

We can finish the estimate of the variable $\lpsl$ by computing:
\begin{displaymath}
\begin{split}
\Expect{\lpsl}	& \leq \displaystyle \sum_{i = 0}^{\infty} m \Prob{\psl \geq i} \\
		& \leq \displaystyle \sum_{i = 0}^{\infty} m \min\left(1, \dbinom{n}{i}\left(\frac{1}{m}\right)^i\right) \\
		& = O\left(\frac{\log n}{\log \log n}\right)
\end{split}
\end{displaymath}

In the last calculation we assumed that the table's load factor is lower than 1 or equivalently $n < m$. Whole proof can be found in \cite{DBLP:books/sp/Mehlhorn84}.
\end{section}

\begin{section}{Estimate of $\lpsl$ for models of universal hashing}
The computation for universal hashing needs to be extended by a new probability estimate of collision of $i$ elements. We use the properties of strongly $\omega$-universal class of hash functions. We can also exploit specific properties of various universal classes. This is not the case of this analysis.

\begin{definition}[Set indicator]
Let $\Indicator$ be a function such that
\begin{displaymath}
\Indicator: 2^U \rightarrow \lbrace 0, 1 \rbrace
\end{displaymath}
\begin{displaymath}
\Indicator(M) = \left\{ 
\begin{array}{l l}
  0 & \quad M = \emptyset \\
  1 & \quad M \neq \emptyset \\
\end{array} \right.
\end{displaymath}

Then $I$ is called a set indicator.
\end{definition}

The relationship between the size of the set $M$ and its indicator is described by the next remark.
\begin{remark}
\[\Indicator(M) \leq |M| \textit{.} \]
\end{remark}
\begin{proof}
If $M = \emptyset$ then $I(M) = 0 = |M|$ and the inequality holds. 

If $M \neq \emptyset$ then $I(M) = 1 \leq |M|$ so the statement is true.
\end{proof}

Now we present a method how to estimate the probability of collision of $k$ elements.
\begin{definition}[Collision sets of $k$ elements]
Let $h \in H$ be the universal function used, $k \in \mathbb{N}_0$ be supposed number of colliding elements and $a \in B$ be the collision bucket. Define sets $M_{\geq k}(h, a)$ and $M_{= k}(h, a)$ as
\begin{displaymath}
\begin{split}
M_{\geq k}(h, a) & = \{Y \subseteq S \setdelim |Y| \geq k, h(Y) = \{a\}\} \\
M_{= k}(h, a) & = \{Y \subseteq S \setdelim |Y| = k, h(Y) = \{a\}\} 
\end{split}
\end{displaymath}
\end{definition}

When it is clear from context we can omit parametrisation of the sets and use the notation $M_{\geq k}$ or $M_{= k}$. Simply said, sets $M_{\geq k}$, $M_{= k}$ denote the subsets of the hashed set $S$ of size greater or equal to $k$ which are hashed to a same value $a$. 

\begin{lemma}
\label{lemma-indicator-k-collision}
If $h: U \rightarrow B$ is a hash function mapping a universe $U$ to a hash table $B$ then for any bucket $a \in B$ non-emptiness of set $M_{\geq k}(h, a)$ is equivalent to the non-emptiness of set $M_{= k}(h, a)$ or equivalently
\begin{displaymath}
\Indicator(M_{\geq k}(h, a)) = \Indicator(M_{= k}(h, a)) \text{.}
\end{displaymath}
\begin{proof}
Let $M_{\geq k}$ be a non empty set, then:
\begin{displaymath}
\begin{split}
Y \in M_{\geq k} 
	& \Rightarrow \forall Y' \subseteq Y, |Y'| = k: h(Y') = \{a\} \\
	& \Leftrightarrow \forall Y' \subseteq Y, |Y'| = k: Y' \in M_{=k} \\
	& \Rightarrow \exists Y' \subseteq Y, |Y'| = k: Y' \in M_{=k} \text{.}
\end{split}
\end{displaymath}

Let $M_{=k}$ be a non empty set:
\begin{displaymath}
Y' \in M_{=k} \Rightarrow Y' \in M_{\geq k} \text{.}
\end{displaymath}

Now we have:
\begin{displaymath}
\begin{split}
M_{\geq k} \neq \emptyset & \Leftrightarrow  M_{= k} \neq \emptyset \\
\Indicator(M_{\geq k}) & = \Indicator(M_{= k}) \text{.}
\end{split}
\end{displaymath}
\end{proof}
\end{lemma}

We choose and fix any arbitrary element, bucket, $a \in B$. If the chain of the selected element $a$ has $\psl(a, h) \geq k$ then there must exists a subset $Y$ of hashed set $S \subset U$ such that function $h$ is constant on $Y$ and $h(Y) = \{ a \}$. If $\psl(a, h) = k$ then set $Y$ must be maximal considering its size. Hence it may not be possible to extend the set $Y$ to a larger set hashed just onto $a$. We can write down the probability density function of $\psl(a)$ as:
\begin{displaymath}
\begin{split}
\Prob{\psl(a) \geq k} & = \frac{\sum\displaylimits_{h \in H} \Indicator(\{ Y \subseteq S \setdelim |Y| \geq k, h(Y) = \{ a \} \})}{|H|} \\
\Prob{\psl(a) = k} & = \frac{\sum\displaylimits_{h \in H} \Indicator(\{ Y \subseteq S \setdelim |Y| = k, h(Y) = \{ a \}, Y \text{ is maximal} \})}{|H|} \\
\end{split}
\end{displaymath}

We add some remarks clarifying the following calculations:
\begin{itemize}
\item Every chain is determined by a single element $a$ which is included in it.
\item Probability estimate is always computed for a single set $S$ and probability space corresponds to a choice of hash function $h \in H$.
\item We want to obtain an estimate $\Prob{\psl(a) \geq k} \leq p(B, U, H, |S|)$. This estimate is then used to estimate the distribution function of $\lpsl$: \[ \Prob{\lpsl(h) \geq k} \leq |B| p(B, U, H, |S|) \text{.} \] 
\item The obtained estimate does not depend on the hashed hashed set $S$ directly, just on its size $n$.
\end{itemize}

Lemma \ref{lemma-indicator-k-collision} allows us to estimate the probability of collision of more than $k$ elements.
\begin{displaymath}
\begin{split}
\Prob{\psl(a) \geq k}
	& = \frac{\sum\displaylimits_{h \in H} \Indicator(\{ Y \subseteq S \setdelim |Y| \geq k, h(Y) = \{ a \} \})}{|H|} \\
	& = \frac{\sum\displaylimits_{h \in H} \Indicator(\{ Y \subseteq S \setdelim |Y| = k, h(Y) = \{ a \} \})}{|H|} \\
	& \leq \frac{\sum\displaylimits_{h \in H} |\{ Y \subseteq S \setdelim |Y| = k, h(Y) = \{ a \} \}|}{|H|} \\
	& = \frac{|\{ (h, Y) \setdelim |Y| = k, h(Y) = \{ a \} \}|}{|H|} \\
	& = \frac{\sum\displaylimits_{Y \subseteq S, |Y| = k} | \{ h \in H \setdelim h(Y) = \{a\} \}|}{|H|} \\
\end{split}
\end{displaymath}

Estimate of the last expression must be obtained from the properties unique to the class $H$. In this case we use strong $\omega$-universality since we assume it in the following theorem.

\begin{theorem}
If $H$ is strongly $\omega$-universal system, then $\Expect{\lpsl} \in O\left(\frac{\log n}{\log \log n}\right)$.
\end{theorem}
\begin{proof}
\begin{displaymath}
\begin{split}
P(\psl(a) \geq k) 
	& \leq \frac{\sum\displaylimits_{Y \subseteq S, |Y| = k} | \{ h \in H | h(Y) = \{a\} \}|}{|H|} \\
	& = \frac{\sum\displaylimits_{Y \subseteq S, |Y| = k} \frac{|H|}{{|B|}^{k}}}{|H|} \\
	& = \dbinom{|S|}{k}\frac{1}{{|B|}^k}
\end{split}
\end{displaymath}

Now we can carry on as in the case of standard model of hashing. The probability estimate of collision of $k$ elements is exactly the same and we gain the same result $\Expect{\lpsl} = O\left(\frac{\log n}{\log \log n}\right)$.
\end{proof}

Constructing small strongly $\omega$-universal systems is problematic. In this work we used systems of linear maps and their specific properties not related to strong universality to obtain an interesting upper bound on the variable $\lpsl$. This upper bound allowed us to guarantee the worst case amortised time for every operation.
\end{section}
