\chapter{Systems of universal classes of functions}

\section{Universal classes of functions}
% TODO: Odkazy na jednotlive systemy
% TODO: Citacia na clanok s definiciami.

\begin{definition}[$c$-universal class of hash functions]
\label{c_universal_system}
Let $c \in R$ be a positive number and $H$ be a set of functions $h: U \rightarrow A$ such that for each pair of different elements $x, y \in U$, $x \neq y$ we have \[ \left| \lbrace h \in H \setdelim h(x) = h(y) \rbrace \right| \leq \frac {c |H|}{|A|} \textit{.} \] The set $H$ is then called $c$-universal class of hash functions.
\end{definition}

At first notice the expected fact that the bound on the number of colliding functions for each domain pair is proportional to the size of the class $H$. More interesting is the inverse proportionality to the size of the hash table. Since the set $A$ can be seen as a hash table. A generalisation of the above definition provides us with an estimate of the number of colliding functions for more than two elements. This count becomes inversely proportional to the power of the table size.

\begin{definition}[Strongly $n$-universal class of hash functions]
\label{strong_universal_n_system}
Let $n \in N$ and $H$ be a set of functions $h: U \rightarrow A$ such that for every choice of $n$ different elements $x_1, x_2, \dots, x_n \in U$ and their images $y_1, y_2, \dots, y_n \in A$ the following holds \[ \left|\lbrace h \in H \setdelim h(x_1) = y_1, h(x_2) = y_2, \dots, h(x_n) = y_n \rbrace \right| = \frac{|H|}{|A|^n} \textit{.} \] Then the system of functions $H$ is called strongly $n$-universal class of hash functions.
\end{definition}

\begin{definition}[Strongly $\omega$-universal class of hash functions]
\label{strong_universal_omega_system}
Family of functions $H$ is strongly $\omega$-universal if and only if it is strongly $n$-universal for every $n \in N$.
\end{definition}

% TODO: Citacia na clanok o systeme omega univerzalnych funkcii.
Such systems provide us with and estimate of the length of the longest chain in the hashing table. This bound can be proved directly from the above property without regarding any other special attributes of a system. So the above property is difficult to be satisfied by a small class of functions. A straightforward example is the set of all function from the domain $U$ to a hash table $A$. As mentioned this system is not very convenient because of its size.

\begin{remark}
Every 2-strongly universal class of hash functions is also 1-universal.
\end{remark}
\begin{proof}
We need to find the number of functions that make a given pair of elements $x, y \in U$, $x \neq y$ collide. The collision for a function $h \in H$ and given pair can be formally written as $h(x) = h(y)$. The collision may occur for every possible image $t \in A$. Now define the set of functions that display bot $x$ and $y$ on the image $t$ \[ H_t = \lbrace h \in H \setdelim h(x) = h(y) = t \rbrace \textit{.} \] These sets are disjoint and moreover $|H_t| = \frac{|H|}{{|A|}^{2}}$. By summing throughout all $t \in A$ we have
\begin{displaymath}
|\lbrace h \in H \setdelim h(x) = h(y) \rbrace | = \displaystyle \sum_{t \in A} |H_t| = |A| \frac{|H|}{{|A|}^{2}} = \frac{H}{|A|}\textit{.}
\end{displaymath}
The number of colliding functions is then exactly $\frac{H}{|A|}$ and the system $H$ is 1-universal.
\end{proof}

\begin{remark}
Every strongly $n$-universal class of functions is strongly $k$-universal for every $1 \leq k \leq n$.
\end{remark}
\begin{proof}
We use an approach similar to one used in the proof of the previous remark. We are given $k$ different elements $x_1, \dots, x_k \in U$ and their images $y_1, \dots, y_k$. We need to find the number of functions that display the element $x_i$ to its image $y_i$. The estimate from the strong $n$-universality is for $n$ elements only. The set of images is extended by $n - k$ elements that are allowed to map on arbitrary bucket, element of the set $A$.

The set of functions mapping given $k$ elements onto their prescribed images, $\bar H$,  may be seen as:
\[
\begin{split}
\bar{H}	& = \lbrace h \in H \setdelim h(x_i) = y_i, i \in \lbrace 1, \dots, k \rbrace \rbrace \\
	& = \displaystyle \bigcup_{y_{k+1}, \dots, y_n \in A} \lbrace h \in H \setdelim h(x_i) = y_i, i \in \lbrace 1, \dots, n \rbrace \rbrace \textit{.}
\end{split}
\]

Notice that the sets of functions that display elements $x_{k + 1}, \dots, x_n$ onto different images $y_{k + 1}, \dots, y_n$ are disjoint. The sum of their size is then equal to $|\bar H|$.
\[
\begin{split}
|\bar H|& = \left| \displaystyle \bigcup_{y_{k+1}, \dots, y_n \in A} \lbrace h \in H \setdelim h(x_i) = y_i, i \in \lbrace 1, \dots, n \rbrace \rbrace \right| \\
	& = \displaystyle \sum_{y_{k+1}, \dots, y_n \in A} \left| \lbrace h \in H \setdelim h(x_i) = y_i, i \in \lbrace 1, \dots, n \rbrace \rbrace \right| \\
	& = \displaystyle \sum_{y_{k+1}, \dots, y_n \in A} \frac{H}{{|A|}^{n}} = {|A|}^{n - k} \frac{H}{{|A|}^{n}} = \frac{H}{{|A|}^{k}}
\end{split}
\]

Now we can see that the class of functions $H$ is strongly $k$-universal, too.
\end{proof}

\section{Examples of universal classes of functions}
In this section we show some examples of common universal classes of hash functions. With each system we provide a simple proof of its universality or strong universality. The systems differ in their domains and codomains. However every presented system can be thought as a mapping from a subset of natural numbers onto another subset of natural numbers.

% Linear systems
\paragraph{Linear system}
System of linear functions was among the first systems of universal hash functions introduced by Carter and Wegman in \cite{DBLP:journals/jcss/CarterW79}. In the article they showed basic properties of universal hashing. Above all they mentioned the expected constant time of the find operation.
\begin{definition}[Linear system]
Let $N$ be a prime and $m$ be a natural number. Define the sets $U = \{0, \dots, N - 1 \}$ and $A = \{0, \dots, m - 1\}$. Then the class of linear functions 
\[ LS = \{h_{a, b}(x): U \rightarrow A \setdelim a, b \in U \textit{where} h_{a, b}(x) = ((ax + b) \mod N) \mod m \} \]
is called the linear system.
\end{definition}

\begin{remark}
Linear system is $\frac{\left(\left\lceil \frac{N}{m} \right\rceil\right)^2}{\left(\frac{N}{m}\right)^2}$-universal.
\end{remark}
\begin{proof}
Consider two different elements $x, y \in U$. We need to compute the number of functions $h_{a, b} \in H$ for which 
\[ (ax + b \mod N) \mod m = (ay + b \mod N) \mod m \textit{.} \]

This is equivalent to the existence of numbers $r, s, t$ that satisfy the following constraints.
\begin{gather*}
r \in \{0, \dots, m - 1 \} \\
t, s \in \{0, \dots, \left \lceil \frac{N}{m} \right \rceil - 1\} \\
(ax + b) \mod N = s m + r \\
(ay + b) \mod N = t m + r \\
\end{gather*}

Since $N$ is a prime number and $x \neq y$ for every choice of parameters $r, s, t$ there is a solution, parameters $a, b$, that satisfy the equalities.
Number of possible choices of parameters $r, s, t$ is.
\end{proof}
% End linear systems

% Linear transformations
\paragraph{System of linear transformations}
\begin{definition}{System of linear transformations}
Nech $A$, $B$ sú dva vektorové priestory nad $Z_2$ pričom platí $dim(A) = m$ a $dim(B) = n$. Systém funkcií 
\begin{displaymath}
H = \{L : A \rightarrow B \setdelim L \text{ je lineárne zobrazenie}\}
\end{displaymath}
nazveme systém lineárnych zobrazení.
\end{definition}
\begin{remark}
Systém lineárnych zobrazení je $1$-univerzálny.
\end{remark}
\begin{proof}
Označme $(T)_{i, j}=t_{i, j}$ ako maticu lineárneho zobrazenia. Máme zadané dva rôzne prvky $x$, $y$ z priestoru $A$, nech sa líšia na $k$-tom mieste. Nech všetky prvky matice $T$ okrem $k$-teho stĺpca sú definované. Teraz sme schopní jednoznačne určiť ostávajúce hodnoty, pre, $1 \leq i \leq n$, $i$-ty riadok máme:
\begin{displaymath}
\begin{split}
\displaystyle\sum_{j = 1}^{m}t_{i, j}x_j & = \displaystyle\sum_{j = 1}^{m}t_{i, j}y_j \\
t_{i, k} & = (x_k - y_j)^{-1}\displaystyle\sum_{j = 1, j \neq k}^{m}t_{i, j}(y_j - x_j)
\end{split}
\end{displaymath}
Teda $k$-ty stĺpec môžeme jednoznačne určiť. Počet všetkých funkcií je $2^{mn}$ a kolíznych zobrazení je $2^{(m-1)n}$.
\begin{displaymath}
2^{(m-1)n} = \frac{2^{mn}}{2^n}
\end{displaymath}
Systém lineárnych zobrazení je $1$-univerzálny.
\end{proof}
% End linear transformations

% Polynoms
\paragraph{Polynómy nad konečnými poliami}
\begin{definition}[Polynómy nad konečnými poliami]
Nech $U = \{0, \dots, N - 1 \}$, $A = \{0, \dots, m - 1\}$ a $n \in N$. Potom systém funkcií 
\[ H = \{h(x): U \rightarrow A | h(x) = ((\displaystyle \sum_{i=0}^{n} c_i x^i ) \mod N) \mod m\} \]
nazveme systém polynomiálnych hashovacích funkcií stupňa $n$. Koeficienty $c_i, i \in \{0, 1, \dots, n\}$ volíme z množiny $U$.
\end{definition}
\begin{remark}
Nech $N$ je prvočíslo. Systém polynomiálnych hashovacích funkcií stupňa $n$ je silne $n + 1$-univerzálny pre $A = U$. Pre $A \neq U$ je "takmer" silne $n + 1$-univerzálny.
\end{remark}
\begin{proof}
% TODO: Odkaz na Vandermondovu maticu.
Nech prvky $x_1, x_2, \dots, x_{n+1}$ sú po dvojiciach rôzne a $y_1, y_2, \dots, y_{n+1}$ sú zvolené odpovedajúce obrazy. Potom môžeme zostaviť Vandermondovu maticu pre určenie jednotlivých koeficientov $c_0, c_1, \dots, c_n$.

Pokiaľ $U = A$, funkcie $h(x)$ sa redukujú na tvar $h(x) = (\displaystyle \sum_{i=0}^{n} c_i x^i ) \mod N$. Veľkosť systému je ${|U|}^{n+1}$. Pre zadané vzory a ich obrazy z invertibility Vanderomondovej matice dostávame práve jednu funkciu $h$, ktorá spĺňa predpísané podmienky. Za predpokladu $|A| = |U|$ platí ${|A|}^{n+1} = {|U|}^{n+1}$. Ihneď získavame, že systém polynomiálnych funkcií je silne $n+1$-univerzálny.

Teraz nech $U \neq A$. Postupujeme obdobne ako v dôkaze $c$-univerzality lineárneho systému.
\begin{displaymath}
(\displaystyle \sum_{j=0}^{n} c_j x_{i}^{j} ) \mod N = {y}_i + {r_i}{m} \qquad {y}_i \in \{0, \dots, m - 1 \}, r_i \in \{0, m, 2m, \dots, \left\lceil \frac{N}{m} \right\rceil - 1\}
\end{displaymath}
Pre každú voľbu ${y}_i$ a $r_i$ dostávame jednoznačné riešenie sústavy. Pokiaľ sú zadané obrazy $y_i$, hodnoty $r_i$ už môžu byť ľubovoľné. Pre každú voľbu $r_i$ máme jedinú funkciu spĺňajúcu zadané predpoklady. Počet sád $r_i$ je ${\left\lceil \frac{N}{m} \right\rceil}^{n + 1}$ a práve toľko je polynomiálnych hashovacích funkcií, ktoré pošlú zadané vzory na im príslušné obrazy.
\begin{displaymath}
|\{h \in H | h(x_i) = y_i, i \in \{1, \dots, n + 1\}\}| = {\left\lceil \frac{N}{m} \right\rceil}^{n + 1} = \frac{{\left\lceil \frac{N}{m} \right\rceil}^{n + 1}}{(\frac{N}{m})^{n+1}}\left(\frac{N}{m}\right)^{n+1}
\end{displaymath}
\end{proof}
% End polynoms


\paragraph{Bitový súčet reťazca nad konečným poľom}
\begin{definition}
Nech $U = \{0, \dots, N - 1\}$ a $A = \{0, \dots, p - 1 \}$, kde $N = 2^k$ a $p$ je prvočíslo, zvolíme $l \leq p$. Pre každý prvok $x \in U$ budeme chápať zápis $x = x_{k - 1} x_{k-2} \dots x_0$ ako zápis čísla x v binárnej sústave ($x = \displaystyle \sum_{j=0}^{k-1} x_j 2^j$). Systém funkcií 
\begin{displaymath}
H = \{ h: U \rightarrow A | h(x) = (\displaystyle \sum_{i=0}^{k-1} c_i x_i) \mod p, c_i \in \{0, 1, \dots, l - 1\} \}
\end{displaymath} 
nazveme reťazcový systém.
\end{definition}
\begin{remark}
Reťazcový systém je $c$-univerzálny, pre $c = \frac{p}{l}$.
\end{remark}
\begin{proof}
Vieme, že $|H| = l^k$. Nech $x, y \in U$ a $x \neq y$, existuje $0 \leq j \leq k-1$, t.ž. $x_j - y_j \neq 0$.
Nech $h(x) = h(y)$, potom:
\begin{displaymath}
\begin{split}
\left(\displaystyle \sum_{i=0}^{k-1} c_i x_i\right) \mod p & = \left(\displaystyle \sum_{i=0}^{k-1} c_i y_i\right) \mod p \\
c_j(x_j - y_j) \mod p & = \left(\displaystyle \sum_{i=0, i \neq j}^{k-1} c_i (x_i - y_i)\right) \mod p \\
c_j & = (x_j - y_j) ^ {-1}\left(\displaystyle \sum_{i=0, i \neq j}^{k-1} c_i (x_i - y_i)\right) \mod p
\end{split}
\end{displaymath}
Posledná rovnosť platí, pretože $p$ je prvočíslo a prvok $x_j - y_j$ je invertibilný. Pri výbere funkcií, ktoré dané dva rôzne prvky nechajú kolidovať, sme o voľbu jednej konštanty $c_j$ ochudobnení. 

\begin{displaymath}
|\{h \in H | h(x) = h(y) \}| = l^{k-1} = \frac{p}{l}\frac{l^k}{p} = c\frac{|H|}{|A|}
\end{displaymath}
\end{proof}

% All functions
\paragraph{Množina všetkých zobrazení}
\begin{remark}
Systém všetkých zobrazení $h: U \rightarrow A$ je silne $\omega$-univerzálny.
\end{remark}
\begin{proof}
Platí:
\begin{displaymath}
|H| = {|A|}^{|U|}
\end{displaymath}
Nech máme zadaných $n$ po dvojiciach rôznych vzorov $x_1, \dots, x_n$ a im odpovedajúce obrazy $y_1, \dots, y_n$. Veľkosť $H_n = \lbrace h \in H | h(x_i) = y_i, i \in \lbrace 1, \dots, n \rbrace \rbrace$ je:
\begin{displaymath}
|H_n| = {|A|}^{|U| - n} = \frac{{|A|}^{|U|}}{{|A|}^{n}} = \frac{|H|}{|A|^n}
\end{displaymath}
\end{proof}

Pamätať si úplné zobrazenie zo systému $H$ je nepraktické. Kódujeme aj hodnoty prvkov, ktoré sa nikdy v hashovanej množine nevyskytnú. Alternatívou je konštruovať náhodnú parciálnu funkciu z množiny všetkých zobrazení z $U$ do $A$ nasledujúcim spôsobom. Vychádzame z predpokladu existencie rýchlej asociatívnej pamäti a generátora náhodných prvkov. Kedykoľvek máme hashovať prvok, tak chceme určiť hodnotu hashovacej funkcie. Najprv pomocou asociatívnej pamäti zistíme, či už nemá priradenú hodnotu. Ak nie, vygenerujeme náhodný prvok z množiny $A$ a do asociatívnej pamäti toto zobrazenie poznamenáme. Jedná sa o postupnú konštrukciu funkcie z množiny všetkých zobrazení. Nakoľko táto konštrukcia vyberá prvky rovnomerne, zostrojená funkcia má vlastnosti silne $\omega$-univerzálneho systému. Navyše nemáme uložené mapovanie pre prvky, ktoré sme doteraz nepotrebovali.
% End all functions

\paragraph{Malý univerzálny systém}


\paragraph{Systém definovaný pomocou matíc}

\section{Properties of systems of universal functions}
In this section we sum up some properties of $k$-strongly universal classes of functions. We concentrate on the generalisation of the known properties of the $c$-universal classes to the strongly universal classes.

The first theorems show the results of combinations of two strongly universal systems.
\begin{theorem}
Let $H$ and $I$ be $k$-strongly universal systems both mapping the universe $U$ to the table of size $m$. Then the system of pair functions 
\begin{displaymath}
J = \lbrace f_{(h, i)}:U \times U \rightarrow \lbrace 0, \dots, m - 1 \rbrace \times \lbrace 0, \dots, m - 1 \rbrace | h \in H, i \in I \rbrace
\end{displaymath} 
is also $k$-strongly universal. Result of a pair function $(h, i)$ is $f_{(h, i)}(x) = (h(x), i(x))$.
\end{theorem}
\begin{proof}
Let $x_1, \dots, x_k$ be the elements that are supposed to be mapped onto selected buckets $(y_1, z_1), \dots, (y_k, z_k)$. The number of functions mapping both $h(x_1) = y_1, \dots, h(x_k) = y_k$ and $i(x_1) = z_1, \dots, i(x_k) = z_k$ is $\frac{|H|}{m^k}$ or $\frac{|I|}{m^k}$ respectively. So the number of all functions mapping $h(x_1) = (y_1, z_1), \dots, h(x_k) = (y_k, z_k)$ is equal to $\frac{|H||I|}{m^{2k}}$. The size of the table is $m^2$ and hence the constructed system is $k$-strongly universal.
\end{proof}

Combining two universal systems is not only limited to increasing the table's size. From the previous result we obtain a smaller probability of collision by paying the expensive price of the table expansion. When using a single function the same effect can be achieved by squaring the table size.  We could also combine two strongly universal functions and use a suitable operation to merge the given results into a smaller table. The system created remains strongly universal as it is stated in the next theorem.

\begin{theorem}
Let $B$ denote the set of buckets of a hash table of size $m$ thus $|B| = m$. Both $H$ and $I$ are $k$-strongly universal classes of functions over the table $B$. The operation $o: B \times B \rightarrow B$ is given so that for every $c, a \in B$ there is exactly one $b \in B$ such that $o(a, b) = c$. Then the system of functions $F = \lbrace f_{(h, i)} | h \in H, i \in I \rbrace$ where $f_{(h, i)}(x) = o(h(x), i(x))$ is $k$-strongly universal.
\end{theorem}
\begin{proof}
The given elements $x_1, \dots, x_k$ are supposed to be mapped onto the prescribed images $y_1, \dots, y_k$. For every $y_i$ there are exactly $m$ pairs $(a_i, b_i)$ such that $o(a_i, b_i) = y_i$. The probability of event $h(x_1) = a_1, \dots, h(x_k) = a_k$ and $i(x_1) = b_1, \dots, i(x_k) = b_k$ is exactly $\frac{1}{m^{2k}}$. The pair for a single value $y_i$ may be chosen arbitrarily for every $1 \le i \le k$. There are $m^k$ pairs that confirm the values $y_i$. Now we see that $P(f(x_i) = y_i, 1 \le i \le k) = \frac{m^k}{m^{2k}} = \frac{1}{m^k}$.
\end{proof}

\begin{corollary}
Combining the results of pair functions created from $k$-strongly universal classes by the operation:
\begin{itemize}
\item $xor$ where the table size is a power of 2
\item $+$, $-$ over an additive group $Z_l$ where $l$ is the table size
\end{itemize}
gives $k$-strongly universal classes of functions.
\end{corollary}

Next step is to discover the dependence of the parameter $k$ of strongly universal classes on their size. This will show us the best possible probability estimate for the collision.
\begin{theorem}
If $H$ is a $k$-strongly universal system of functions. Then the size of the system is bounded by:
\begin{displaymath}
|H| > m^{k - 1} \log_m \left( \frac{N}{km} \right) \textit{.}
\end{displaymath}

The strong universality of every such system of functions $H$ has its upper bound
\begin{displaymath}
k < 1 + \frac{\log |H| - \log \log_m \left( \frac{N}{km} \right)}{\log m} \textit{.}
\end{displaymath}
\end{theorem}
\begin{proof}
First we will construct the sequence of sets $U_0$, $U_1$, $\dots$, where $U_0 = U$. The set $U_i$ is the greatest subset of $U_{i - 1}$ that collides under the function $h_i \in H$. From the Dirichlet's principle the size of every set $U_i$ may be estimated as $|U_i| \geq \frac{|U_{i - 1}|}{m}$. By using a bounded induction one can obtain $|U_i| \geq \frac{|U|}{m^i}$.

Now let the index $i$ denote the last set $U_i$ such that $|U_i| \geq k$. The functions $h_1, h_2,\dots, h_i$ map at least $k$ elements of the set $U_i$ to a single image. The probability of this event is less or equal to $\frac{1}{m ^ {k - 1}}$. From this argument we know that $i \leq \frac{|H|}{m ^ {k - 1}}$. Since the index $i$ is last with the property $U_i \geq k$ we also have that $\frac{|U|}{m ^ {i + 1}} < k$. 

Putting it all together:
\begin{gather*}
\frac{N}{m^{i + 1}} < k \\
\frac{N}{k} < m ^ {i + 1} \\
\frac{\log \left( \frac{N}{km} \right)}{\log m} < i \\
\log_m \left( \frac{N}{km} \right) < i \\
\end{gather*}

Obtaining the bound on the size of system of functions:
\begin{displaymath}
\begin{split}
\frac{|H|}{m^{k - 1}} & \geq i > \log_m \left( \frac{N}{km} \right) \\
|H| & > m^{k - 1} \log_m \left( \frac{N}{km} \right) \\
\end{split}
\end{displaymath}

This can be rewritten to get bound on $k$ as:
\begin{displaymath}
\begin{split}
m^{k - 1} & < \frac{|H|}{\log_m \left( \frac{N}{km} \right)} \\
k & < 1 + \frac{\log |H| - \log \log_m \left( \frac{N}{km} \right)}{\log m} \\
\end{split}
\end{displaymath}
\end{proof}
